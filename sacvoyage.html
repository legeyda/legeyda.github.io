<html>
      <head>
            <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
            <link rel="stylesheet" href="style.css">
            <script language="JavaScript" src="bootstrap/js/bootstrap.min.js"></script>
            <style>
            	.container {
            		padding-top: 1em;
            	}
            </style>
      </head>
<body>
	<div class="container">















<div class="alert alert-warning">
	<p><strong>This is draft of sacvoyage-storage description</strong></p>
</div>

<h1>Introduction</h1>
	
<p>Sacvoyage is document-oriented storage system and client API to access this storage.
The main purpose of sacvoyage is to store personal information like
notes, calendar, files etc.</p>



<h2>Structure</h2>



<h3>Assets &amp; Notebooks</h3>

<p>All sacvoyage data is organized in assets. Usually, each user gets his own asset,
named after her name. User is granted with full access to her asset.
Asset consist of multiple notebooks, which are collections of notes.
Each note is JSON-object. 
Sacvoyage notebooks and notes can be thought of like
mongodb collections and documents. </p>



<h3>Notes</h3>

<p>A notebook consist of notes, which are JSON-objects of schema-less structure.
Say, we save a new note to an empty notebook:</p>

<pre class="prettyprint">{
	"_id":  "KASU73I37A3I",
	"note": "Buy some cheeze",
	"due" : "20150113142500"
}</pre>


<p>The <code class="prettyprint">_id</code> has special meaning. 
It is an identifier of the note which is unique among notes in the notebook. 
<code class="prettyprint">_id</code> can be set by client or, 
if not, generated by sacvoyage server automatically. 
In this case <code class="prettyprint">_id</code> is 16 or more random characters.
It should be enough to avoid collisions</p>.



<h2>Versioning</h2>

<p>Each time you update note, instead of overwriting the old content
the new note version is added to notebook.
So, so now the content of the notebook is:</p>

<pre class="prettyprint">[{
	"_id":      "KASU73I37A3I",
	"_version": "20150111142500.000000-SWQI",
	"_latest":  false,
	"note":     "Buy some cheese",
	"due" :     "20150113142500"
}, 
{
	"_id":      "KASU73I37A3I",
	"_version": "201501121632500.000000-DLSE"
	"_latest":  true,
	"note":     "Buy some cheese and bread",
	"due" :     "20150113142500"
}]</pre>

<p>Here we see new properties: 
<code class="prettyprint">_version</code> and <code class="prettyprint">_latest</code>.
These properties are stored internally and normally are excluded from query result,
unless user explicitly tells to include them.
<code class="prettyprint">_version</code> is version identifier which
is unique among all versions of the single note.
The note version with <code class="prettyprint">_version</code>, 
that is lexicographically the last is treated as active version.
The <code class="prettyprint">_latest</code> in active version is set to 
<code class="prettyprint">true</code>. All other (previous) versions
<code class="prettyprint">_latest=true</code></p>

<p>The default (and the safest) approach to delete note
is to save new version of the note,
with flag <code class="prettyprint">_deleted</code>
set to <code class="prettyprint">true</code></p>

<pre class="prettyprint">[{
	"_id":      "KASU73I37A3I",
	"_version": "20150111142500.000000-SWQI",
	"_latest":  false,
	<strong>"_deleted": false,</strong>
	"note":     "Buy some cheese",
	"due" :     "20150113142500"
}, 
{
	"_id":      "KASU73I37A3I",
	"_version": "201501121632500.000000-DLSE"
	"_latest":  true,
	<strong>"_deleted": false,</strong>
	"note":     "Buy some cheese and bread",
	"due" :     "20150113142500"
}, 
{
	"_id":      "KASU73I37A3I",
	"_version": "201501121632500.000000-DLSE"
	"_latest":  true,
	<strong>"_deleted": true,</strong>
	"note":     "Buy some cheese and bread",
	"due" :     "20150113142500"
}]</pre>

<p>This approach can simplify querying the notebook,
but can lead to consuming much storage space.</p>

<p>User can explicitly use other approaches to delete note.</p>

<ul>
	<li>
		<p>Write an dummy note version:</p>
		<pre class="prettyprint">[{
	"_id":      "KASU73I37A3I",
	"_version": "20150111142500.000000-SWQI",
	"_latest":  false,
	<strong>"_deleted": false,</strong>
	"note":     "Buy some cheese",
	"due" :     "20150113142500"
}, 
{
	"_id":      "KASU73I37A3I",
	"_version": "201501121632500.000000-DLSE"
	"_latest":  true,
	<strong>"_deleted": false,</strong>
	"note":     "Buy some cheese and bread",
	"due" :     "20150113142500"
}, 
{
	"_id":      "KASU73I37A3I",
	"_version": "201501121632500.000000-DLSE"
	"_latest":  true,
	<strong>"_deleted": true,</strong>
}]</pre>
		<p>In this case not much user space is consumed.</p>
	</li>


	<li>
		<p>Overwrite last version, adding setting _deleted flag to tru:</p>
		<pre class="prettyprint">[{
	"_id":      "KASU73I37A3I",
	"_version": "20150111142500.000000-SWQI",
	"_latest":  false,
	<strong>"_deleted": false,</strong>
	"note":     "Buy some cheese",
	"due" :     "20150113142500"
}, 
{
	"_id":      "KASU73I37A3I",
	"_version": "201501121632500.000000-DLSE"
	"_latest":  true,	
	<strong>"_deleted": true,</strong>
	"note":     "Buy some cheese and bread",
	"due" :     "20150113142500"
}]</pre>
		<p>In this case not we solve the problem with queries,
			but this approach can break versioning.</p>
	</li>

</ul>



<h2>API</h2>

<p>Sacvoyage exposes HTTP RESTfull API.
Nonstandard request method 
(<code class="prettyprint">PUT</code>, <code class="prettyprint">DELETE</code> etc.)
can be emulated with POST requests (_action=PUT).
Session management is like any web application: 
after logging in, user gets session token which he must supply to the server with all subsequent requests.</p>

<p>For the following examples, suppose, you have sacvoyage server running at 
<a href="http://sacvoyage.local/">http://sacvoyage.local/</a></p>



<h3>Logging in</h3>

<p>To start working with sacvoyage user (or application) must log into the system 
with her user name and password:</p>

<pre class="prettyprint lang-bash">curl --data "user=john&amp;password=querty" sacvoyage.local/login
200</pre>

<p>In case of successful authorization server answers with code 200 and 
returns a cookie with session token.</p>



<h3>Assets &amp; Notebooks</h3>

<p>Once logged in, user obtains access to all assets (usually, just one, corresponding hit name).
He can get list of them:</p>

<pre class="prettyprint lang-bash">curl sacvoyage.local/assets
["john"]</pre>

<p>asset options</p>

<pre class="prettyprint lang-bash">curl sacvoyage.local/assets/john
["files", "notes", "versions"]</pre>

<p>that are: </p>

<dl class="dl-horizontal">
	<dt>files</dt>
	<dd>file storage in notes</dd>

	<dt>notes</dt>
	<dd>latest versions of notes</dd>

	<dt>versions</dt>
	<dd>all versions of notes</dd>
</dl>

<p>and list of available notebooks: </p>

<pre class="prettyprint lang-bash">curl sacvoyage.local/assets/notebooks
["default", "work", "othernotebook"]</pre>



<h3>Saving data</h3>

<p>Data can be just <code class="prettyprint">PUT</code> into notebook:</p>

<pre class="prettyprint lang-bash">curl -X PUT --data '{         \
	"_id":      "KASU73I37A3I"     \
	"note":     "Buy some cheese, bread and butter",  \
	"due" :     "20150113142500"     \
}' sacvoyage.local/assets/john/notebooks/default</pre>

<p>In this case we supplied note <code class="prettyprint">_id</code> in note body.
Since we did not mentioned <code class="prettyprint">_version</code>,
versioning will be done implicitly. 
From user perspective, overwriting note will look like simple update, 
but behind the scenes, sacvoyage will create new note version and mark it
as <code class="prettyprint">_latest</code>.</p>

<p>Note <code class="prettyprint">_id</code> can be also supplied in url, 
so this example is completely equivalent to the previous one.</p>

<pre class="prettyprint lang-bash">curl -X PUT --data '{
	"note": "Buy some cheese, bread and butter",  \
	"due" : "20150113142500"     \
}' sacvoyage.local/assets/john/notebooks/default/KASU73I37A3I</pre>

<p>Any custom http-request method can be emulated with 
POST request with <code class="prettyprint">_action=PUT</code>
Previous request could be rewritten as</p>

<pre class="prettyprint lang-bash">curl --data '_action=PUT&amp;{
	"note": "Buy some cheese, bread and butter",  \
	"due" : "20150113142500"     \
}' sacvoyage.local/assets/john/notebooks/default/KASU73I37A3I</pre>

<p>By default, if you do not mention 
<code class="prettyprint">_version</code> property in your requests
you will notice no versioning at all.</p>

<p>An array of notes can also be <code class="prettyprint">PUT</code></p>



<h3>Queries</h3>



<h4>Simple queries</h4>
		
<p>You can get an array of all actual versions of notes by just 
<code class="prettyprint">GET</code>'ing notebook url:</p>

<pre class="prettyprint lang-bash">curl sacvoyage.local/assets/john/notebooks/default
{
	"_id":      "KASU73I37A3I",
	"note":     "Buy some cheese and bread",
	"due" :     "20150113142500"
}</pre>

<p>By default, only latest versions of all notes are returned.</p>

<p>In our request, we did not mentioned any service attributes like
<code class="prettyprint">_latest</code>, 
<code class="prettyprint">_deleted</code> or
<code class="prettyprint">_version</code>,
so sacvoyage will behave like there was not versioning at all.</p>

<p>Simple equality conditions can be passed to GET-requests: </p>

<pre class="prettyprint lang-bash">curl sacvoyage.local/assets/john/notebooks/default?note=Buy+some+cheese+and+bread
[{
	"_id":      "KASU73I37A3I",
	"note":     "Buy some cheese and bread",
	"due" :     "20150113142500"
}]</pre>

<p>Compare to:</p>

<pre class="prettyprint lang-bash">curl sacvoyage.local/assets/john/notebooks/default?note=Buy
[]</pre>



<h4>Sophisticated queries<h4>

<p>To make request, _query-object must be passed to <code class="prettyprint">GET</code>-request. 
_query-object contains all query options supported by sacvoyage</p>



<h5><pre class="prettyprint">_filter</pre>-option</h5>

<p>With <pre class="prettyprint lang-bash">_filter</pre> 
you can configure which notes are included to the query result.</p>

<p>If <pre class="prettyprint">_filter</pre>-option 
is string, it is treated as 
<pre class="prettyprint">_id</pre> and query 
return a note with this _id.</p>

<p>When <pre class="prettyprint">_filter</pre> is object</p>

<p></p>

<p></p>

<p></p>

<p></p>

<p></p>

<p></p>

<p></p>

<p></p>

<p></p>

<p></p>

<p></p>

<p></p>

<p></p>

<p></p>

<p></p>

<p></p>

<p></p>

<p></p>

<p></p>

<p></p>

<p></p>

<p></p>

<p></p>















		</div>
	</body>
<script src="google-code-prettify/run_prettify.js"></script>
</html>
